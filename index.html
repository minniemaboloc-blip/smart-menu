<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Menu</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
#cartModal { background-color: rgba(0,0,0,0.5); }
</style>
</head>

<body class="bg-gray-50 text-gray-800 pb-28">

<script>
const FB_PAGE = "minchis.dvo";
const SHEET_ID = "1ufX4XtO7L4q5BjyeSYWxR-B8MxTCYJ3IMSr2PFZQQ6U";
const SHEET_NAME = "Menu";

const order = {};
let cartTotal = 0;
let cartQty = 0;
</script>

<div class="max-w-3xl mx-auto p-4">

  <!-- Logo -->
  <div class="text-center mb-2">
    <img src="https://scontent.fcgy2-3.fna.fbcdn.net/v/t39.30808-6/593889522_1298553832312180_3090718135975847774_n.jpg"
      class="mx-auto h-16">
  </div>

  <h1 class="text-3xl font-bold text-center mb-1">ðŸ“± Minchi's Smart Menu</h1>
  <p class="text-center text-sm mb-4">Dine-in â€¢ Pickup â€¢ Delivery</p>

  <!-- Customer Info -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <input id="customerName" class="w-full border p-2 rounded mb-2" placeholder="Your Name">
    <input id="tableNumber" class="w-full border p-2 rounded" placeholder="Table No. / Pickup">
  </div>

  <!-- Menu -->
  <div id="menu"></div>
</div>

<!-- Floating Cart -->
<div id="cartBar"
  class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 flex justify-between items-center hidden"
  onclick="openCartModal()">
  <div>
    <p class="font-semibold">ðŸ›’ <span id="cartQty">0</span> item(s)</p>
    <p class="text-sm">â‚±<span id="cartTotal">0</span></p>
  </div>
  <button class="bg-red-600 text-white px-6 py-2 rounded-xl font-semibold">
    View Cart
  </button>
</div>

<!-- Image Preview -->
<div id="imageModal"
  class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center z-50"
  onclick="closeImage()">
  <img id="modalImg" class="max-h-[90%] max-w-[90%] rounded-xl">
</div>

<script>
async function loadMenu() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
  const rows = json.table.rows;

  const menu = {};
  let id = 1;

  rows.forEach(r => {
    if (!r.c[0]) return;
    const item = {
      id: id++,
      cat: r.c[0].v,
      name: r.c[1].v,
      price: Number(r.c[2].v),
      soldOut: String(r.c[3]?.v).toUpperCase() === "TRUE",
      spice: String(r.c[4]?.v).toUpperCase() === "YES",
      image: r.c[5]?.v || ""
    };
    if (!menu[item.cat]) menu[item.cat] = [];
    menu[item.cat].push(item);
  });

  renderMenu(menu);
}

function renderMenu(menu) {
  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML = "";

  Object.keys(menu).forEach(cat => {
    const section = document.createElement("div");
    section.className = "bg-white rounded-xl shadow mb-3";

    section.innerHTML = `
      <button onclick="toggleCategory(this)"
        class="w-full p-4 font-bold flex justify-between text-lg">
        ${cat}<span>â–¾</span>
      </button>

      <!-- GRID: 2 cols mobile, 3 cols larger -->
      <div class="hidden px-4 pb-4 grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
    `;

    const grid = section.querySelector("div");

    menu[cat].forEach(item => {
      const div = document.createElement("div");
      div.className = `border rounded-lg p-2 text-center ${
        item.soldOut ? "opacity-50 pointer-events-none" : ""
      }`;

      const img = item.image
        ? `<img src="${item.image}"
             class="w-full h-24 object-cover rounded mb-2 cursor-pointer"
             onclick="openImage('${item.image}')">`
        : "";

      div.innerHTML = `
        ${img}
        <p class="font-semibold text-sm">${item.name}</p>
        <p class="text-xs mb-2">â‚±${item.price}</p>
        <div class="flex justify-center gap-2">
          <button onclick="changeQty(${item.id},'${item.name}',${item.price},-1)"
            class="px-2 bg-gray-200 rounded">âˆ’</button>
          <span id="qty-${item.id}">0</span>
          <button onclick="changeQty(${item.id},'${item.name}',${item.price},1)"
            class="px-2 bg-red-600 text-white rounded">+</button>
        </div>
      `;

      grid.appendChild(div);
    });

    menuDiv.appendChild(section);
  });
}

function toggleCategory(btn) {
  const grid = btn.nextElementSibling;
  grid.classList.toggle("hidden");
  btn.querySelector("span").innerText = grid.classList.contains("hidden") ? "â–¾" : "â–´";
}

function openImage(src) {
  modalImg.src = src;
  imageModal.classList.remove("hidden");
}
function closeImage() {
  imageModal.classList.add("hidden");
}

function changeQty(id,name,price,delta){
  if(!order[id]) order[id]={name,price,qty:0};
  order[id].qty+=delta;
  if(order[id].qty<=0) delete order[id];
  document.getElementById(`qty-${id}`).innerText=order[id]?.qty||0;
  updateCart();
}

function updateCart(){
  cartQty=0; cartTotal=0;
  Object.values(order).forEach(i=>{
    cartQty+=i.qty;
    cartTotal+=i.qty*i.price;
  });
  cartQty ? cartBar.classList.remove("hidden") : cartBar.classList.add("hidden");
  cartQtyEl.innerText=cartQty;
  cartTotalEl.innerText=cartTotal;
}

loadMenu();
</script>

</body>
</html>
