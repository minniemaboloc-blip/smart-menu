<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì±Minchi's Smart Menu</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#f8f8f8;font-family:sans-serif;padding-bottom:28px;}
header{background:#c40000;color:white;padding:15px;text-align:center;}
header h1{font-size:22px;font-weight:bold;margin:0;}
header p{font-size:13px;margin:3px 0;}
.order-type{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap;}
.order-type button{flex:0 0 auto;padding:8px 15px;border-radius:20px;border:1px solid #c40000;background:white;color:#c40000;font-size:13px;cursor:pointer;}
.order-type button.active{background:#c40000;color:white;}
#mainSlider{position:relative;overflow:hidden;margin:10px;}
#mainSlider .slides{display:flex;transition:transform 0.5s ease;}
#mainSlider img{width:100%;height:180px;object-fit:cover;flex-shrink:0;border-radius:15px;margin-bottom:10px;}
#dots{display:flex;justify-content:center;margin:5px 0;}
.dot{height:10px;width:10px;margin:0 3px;background:#ccc;border-radius:50%;display:inline-block;cursor:pointer;}
.dot.active{background:#c40000;}
.category{background:white;margin:10px;border-radius:15px;overflow:hidden;}
.category-title{padding:10px 15px;font-weight:bold;font-size:18px;color:#c40000;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 15px 10px;display:none;}
.menu-item{background:#fafafa;padding:10px;border-radius:10px;border:1px solid #eee;display:flex;flex-direction:column;}
.menu-item h4{margin:0;font-size:14px;}
.menu-item p{margin:5px 0 0;font-size:12px;color:#666;}
.price{margin-top:5px;font-weight:bold;color:#c40000;}
.qty-controls{display:flex;justify-content:space-between;align-items:center;margin-top:5px;}
.qty-controls button{
  width:32px;
  height:32px;
  border:none;
  border-radius:6px;
  font-size:18px;
  color:white;
  background:#c40000;
  cursor:pointer;
}
.qty-controls span{flex:1;text-align:center;font-weight:bold;}
#cartBar{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid #ccc;box-shadow:0 -2px 6px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;padding:10px 15px;cursor:pointer;display:none;}
#cartBar button{background:#c40000;color:white;padding:8px 12px;border-radius:15px;font-weight:bold;}
#cartModal{position:fixed;inset:0;background-color:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
#cartModal .modal-content{background:white;border-radius:15px;max-width:400px;width:90%;padding:15px;}
#cartItems{max-height:200px;overflow-y:auto;margin-bottom:10px;}
#cartItems div{display:flex;justify-content:space-between;margin-bottom:5px;}
#cartItems button{margin-left:5px;padding:2px 5px;border-radius:5px;font-size:12px;}
input{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:5px;}
</style>
</head>
<body>

<header>
  <h1>üì±Minchi's Smart Menu</h1>
  <p>üìç Blk. 38, Lot 21, Phase 1, Elenita Heights Subdivision, Catalunan Grande, Davao City</p>
  <p>üìû 082-391-9679</p>
</header>

<div class="order-type">
  <button class="active" onclick="setOrderType(this)">Dine-In</button>
  <button onclick="setOrderType(this)">Takeout</button>
  <button onclick="setOrderType(this)">Pickup</button>
  <button onclick="setOrderType(this)">Delivery</button>
</div>

<div class="px-4 mb-4">
  <input type="text" id="customerName" placeholder="Your Name">
  <input type="text" id="customerNumber" placeholder="Contact Number">
  <input type="text" id="deliveryAddress" placeholder="Delivery Address" style="display:none;">
</div>

<!-- MAIN SLIDESHOW -->
<div id="mainSlider">
  <div class="slides" id="slides"></div>
  <div id="dots"></div>
</div>

<div id="menu"></div>
<p id="error" class="text-center text-red-600 font-semibold mt-4 hidden">‚ö†Ô∏è Menu failed to load</p>

<div id="cartBar" onclick="openCartModal()">
  <div>
    üõí <span id="cartQty">0</span> item(s)<br>
    Total: ‚Ç±<span id="cartTotal">0</span>
  </div>
  <button>View Cart</button>
</div>

<div id="cartModal">
  <div class="modal-content">
    <h2 class="text-lg font-bold mb-2">üõí Your Cart</h2>
    <div id="cartItems"></div>
    <div class="flex justify-between font-bold mb-2">
      <span>Total:</span>
      <span>‚Ç±<span id="modalTotal">0</span></span>
    </div>
    <button onclick="closeCartModal()" style="background:#ccc;color:black;width:48%;border:none;">Close</button>
    <button onclick="sendOrder()" style="background:#c40000;color:white;width:48%;border:none;">Confirm Order</button>
  </div>
</div>

<script>
const FB_PAGE="minchis.dvo";
let order={},cartQty=0,cartTotal=0,orderType="Dine-In";

function setOrderType(btn){
  document.querySelectorAll(".order-type button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  orderType=btn.innerText;
  document.getElementById("deliveryAddress").style.display=orderType==="Delivery"?"block":"none";
}

const SHEET_ID="1ufX4XtO7L4q5BjyeSYWxR-B8MxTCYJ3IMSr2PFZQQ6U";
const SHEET_NAME="Menu";

async function loadMenu(){
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
    const res = await fetch(url);
    const text = await res.text();
    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}")+1);
    const json = JSON.parse(jsonText);
    const rows = json.table.rows;
    if(!rows || rows.length===0) throw "No rows found";

    const menuDiv = document.getElementById("menu");
    const slidesDiv = document.getElementById("slides");
    const dotsDiv = document.getElementById("dots");
    let menu = {};

    rows.forEach((r)=>{
      if(!r.c || !r.c[0] || !r.c[1] || !r.c[2]) return;
      const cat = r.c[0].v||"Uncategorized";
      const name = r.c[1].v||"Unnamed";
      const price = Number(r.c[2].v||0);
      const soldOut = String(r.c[3]?.v||"").toUpperCase()==="TRUE";
      const spice = String(r.c[4]?.v||"").toUpperCase()==="YES";
      const images = r.c[5]?.v?r.c[5].v.split(","):[];

      if(!menu[cat]) menu[cat]=[];
      menu[cat].push({name,price,soldOut,spice,images});

      // First category slideshow
      if(Object.keys(menu).length===1 && images.length>0){
        images.forEach((img,i)=>{
          const imgel=document.createElement("img");
          imgel.src=img.trim();
          slidesDiv.appendChild(imgel);

          const dot=document.createElement("span");
          dot.className="dot"+(i===0?" active":"");
          dot.onclick=()=>showSlide(i);
          dotsDiv.appendChild(dot);
        });
      }
    });

    // Render categories and items
    Object.keys(menu).forEach(cat=>{
      const catDiv=document.createElement("div");
      catDiv.className="category";

      const title=document.createElement("div");
      title.className="category-title";
      title.innerHTML=`${cat} <span>‚ñæ</span>`;
      title.onclick=()=>toggleCategory(catDiv);
      catDiv.appendChild(title);

      const grid=document.createElement("div");
      grid.className="menu-grid";

      menu[cat].forEach((i,index)=>{
        const item=document.createElement("div");
        item.className="menu-item";
        item.innerHTML=`<h4>${i.name}</h4>
        <p>${i.spice?'Spice Option':''}</p>
        <div class="price">‚Ç±${i.price}</div>
        <div class="qty-controls">
          <button onclick="changeQty('${cat}-${index}','${i.name}',${i.price},-1)">‚ûñ</button>
          <span id="qty-${cat}-${index}">0</span>
          <button onclick="changeQty('${cat}-${index}','${i.name}',${i.price},1)">‚ûï</button>
        </div>`;
        grid.appendChild(item);
      });
      catDiv.appendChild(grid);
      menuDiv.appendChild(catDiv);
    });

    startSlideShow();
  } catch(e){console.error(e); document.getElementById("error").classList.remove("hidden");}
}

function toggleCategory(catDiv){
  document.querySelectorAll(".category").forEach(c=>{
    if(c!==catDiv)c.querySelector(".menu-grid").style.display="none";
    if(c!==catDiv)c.querySelector(".category-title span").innerText="‚ñæ";
  });
  const grid=catDiv.querySelector(".menu-grid");
  const arrow=catDiv.querySelector(".category-title span");
  if(grid.style.display==="grid"){grid.style.display="none"; arrow.innerText="‚ñæ";}
  else{grid.style.display="grid"; arrow.innerText="‚ñ¥";}
}

function changeQty(id,name,price,delta){
  if(!order[id]) order[id]={name,price,qty:0};
  order[id].qty+=delta;
  if(order[id].qty<0) order[id].qty=0;
  if(navigator.vibrate) navigator.vibrate(50);
  document.getElementById(`qty-${id}`).innerText=order[id].qty;
  if(order[id].qty===0) delete order[id];
  updateCart();
}

function updateCart(){
  cartQty=0; cartTotal=0;
  Object.values(order).forEach(i=>{cartQty+=i.qty; cartTotal+=i.qty*i.price;});
  document.getElementById("cartQty").innerText=cartQty;
  document.getElementById("cartTotal").innerText=cartTotal;
  document.getElementById("cartBar").style.display=cartQty>0?"flex":"none";
}

function openCartModal(){
  const itemsDiv=document.getElementById("cartItems"); itemsDiv.innerHTML="";
  Object.entries(order).forEach(([k,i])=>{
    const div=document.createElement("div");
    div.innerHTML=`${i.name} x${i.qty} = ‚Ç±${i.price*i.qty} <button onclick="removeItem('${k}')">‚úï</button>`;
    itemsDiv.appendChild(div);
  });
  document.getElementById("modalTotal").innerText=cartTotal;
  document.getElementById("cartModal").style.display="flex";
}

function removeItem(k){delete order[k];updateCart();openCartModal();}
function closeCartModal(){document.getElementById("cartModal").style.display="none";}

function sendOrder(){
  if(cartQty===0) return alert("Cart is empty");
  const name=document.getElementById("customerName").value;
  const number=document.getElementById("customerNumber").value;
  const address=document.getElementById("deliveryAddress").value;
  if(!name.trim()) return alert("Enter your name");
  let msg=`üìå New Order\nName: ${name}\nContact: ${number}\nType: ${orderType}\n`;
  if(orderType==="Delivery") msg+=`Address: ${address}\n`;
  msg+="\nOrder:\n";
  Object.values(order).forEach(i=>msg+=`‚Ä¢ ${i.name} x${i.qty}\n`);
  msg+=`\nTotal: ‚Ç±${cartTotal}`;
  const encoded=encodeURIComponent(msg);
  window.open(`https://m.me/${FB_PAGE}?text=${encoded}`,"_blank");
}

// SLIDESHOW FUNCTIONS
let slideIndex=0;
function showSlide(n){
  const slides=document.querySelectorAll("#slides img");
  const dots=document.querySelectorAll(".dot");
  if(n>=slides.length) n=0;
  if(n<0) n=slides.length-1;
  slideIndex=n;
  slides.forEach((s,i)=>s.style.display=i===n?"block":"none");
  dots.forEach((d,i)=>d.classList.toggle("active",i===n));
}
function nextSlide(){showSlide(slideIndex+1);}
function startSlideShow(){showSlide(0); setInterval(nextSlide,3000);}

loadMenu();
</script>

</body>
</html>
