<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Menu</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
#cartModal { background-color: rgba(0,0,0,0.5); }
</style>
</head>

<body class="bg-gray-50 text-gray-800 pb-28">

<script>
/* ===== CONFIG ===== */
const FB_PAGE = "minchis.dvo";
const SHEET_ID = "1ufX4XtO7L4q5BjyeSYWxR-B8MxTCYJ3IMSr2PFZQQ6U";
const SHEET_NAME = "Menu";

const order = {};
let cartTotal = 0;
let cartQty = 0;
const deliveryFee = 0;
</script>

<div class="max-w-3xl mx-auto p-4">

  <!-- Logo -->
  <div class="text-center mb-2">
    <img src="https://scontent.fcgy2-3.fna.fbcdn.net/v/t39.30808-6/593889522_1298553832312180_3090718135975847774_n.jpg"
      class="mx-auto h-16">
  </div>

  <h1 class="text-3xl font-bold text-center mb-1">ðŸ“± Minchi's Smart Menu</h1>
  <p class="text-center text-sm mb-4">Dine-in â€¢ Pickup â€¢ Delivery</p>

  <!-- Customer Info -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <input id="customerName" class="w-full border p-2 rounded mb-2" placeholder="Your Name">
    <input id="tableNumber" class="w-full border p-2 rounded" placeholder="Table No. / Pickup">
  </div>

  <!-- Order Type -->
  <div class="bg-white p-4 rounded-xl shadow mb-4">
    <p class="font-semibold mb-2">Order Type</p>
    <label class="block"><input type="radio" name="orderType" value="Dine-in" checked onchange="toggleAddress()"> Dine-in</label>
    <label class="block"><input type="radio" name="orderType" value="Pickup" onchange="toggleAddress()"> Pickup</label>
    <label class="block"><input type="radio" name="orderType" value="Delivery" onchange="toggleAddress()"> Delivery</label>
    <input id="deliveryAddress" class="w-full border p-2 rounded mt-2 hidden" placeholder="Delivery Address">
  </div>

  <!-- Menu -->
  <div id="menu"></div>
</div>

<!-- Floating Cart -->
<div id="cartBar"
  class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 flex justify-between items-center hidden"
  onclick="openCartModal()">
  <div>
    <p class="font-semibold">ðŸ›’ <span id="cartQty">0</span> item(s)</p>
    <p class="text-sm">â‚±<span id="cartTotal">0</span></p>
  </div>
  <button class="bg-red-600 text-white px-6 py-2 rounded-xl font-semibold">View Cart</button>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="fixed inset-0 hidden items-center justify-center">
  <div class="bg-white rounded-xl max-w-md w-full p-4">
    <h2 class="text-xl font-bold mb-4">ðŸ›’ Your Cart</h2>
    <div id="cartItems" class="mb-4"></div>
    <div class="flex justify-between font-semibold mb-4">
      <span>Total:</span>
      <span>â‚±<span id="modalTotal">0</span></span>
    </div>
    <div class="flex justify-between">
      <button onclick="closeCartModal()" class="bg-gray-300 px-4 py-2 rounded">Close</button>
      <button onclick="sendOrder()" class="bg-red-600 text-white px-4 py-2 rounded">Confirm</button>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal"
  class="fixed inset-0 hidden bg-black bg-opacity-70 flex items-center justify-center z-50"
  onclick="closeImage()">
  <img id="modalImg" class="max-h-[90%] max-w-[90%] rounded-xl">
</div>

<script>
function toggleAddress() {
  deliveryAddress.classList.toggle("hidden",
    document.querySelector('input[name="orderType"]:checked').value !== "Delivery");
}

async function loadMenu() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
  const rows = json.table.rows;

  const menu = {};
  let id = 1;

  rows.forEach(r => {
    if (!r.c[0]) return;
    const item = {
      id: id++,
      cat: r.c[0].v,
      name: r.c[1].v,
      price: Number(r.c[2].v),
      soldOut: String(r.c[3]?.v).toUpperCase() === "TRUE",
      spice: String(r.c[4]?.v).toUpperCase() === "YES",
      image: r.c[5]?.v || ""
    };
    if (!menu[item.cat]) menu[item.cat] = [];
    menu[item.cat].push(item);
  });

  renderMenu(menu);
}

function renderMenu(menu) {
  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML = "";

  Object.keys(menu).forEach(cat => {
    const section = document.createElement("div");
    section.className = "bg-white rounded-xl shadow mb-3";

    section.innerHTML = `
      <button onclick="toggleCategory(this)" class="w-full p-4 font-bold flex justify-between">
        ${cat}<span>â–¾</span>
      </button>
      <div class="hidden px-4 pb-4"></div>
    `;

    const content = section.querySelector("div");

    menu[cat].forEach(item => {
      const img = item.image
        ? `<img src="${item.image}" class="w-full h-40 object-cover rounded mb-2 cursor-pointer"
             onclick="openImage('${item.image}')">`
        : "";

      const div = document.createElement("div");
      div.className = `border-t py-3 ${item.soldOut ? "opacity-50 pointer-events-none" : ""}`;

      div.innerHTML = `
        ${img}
        <div class="flex justify-between">
          <div>
            <p class="font-semibold">${item.name}</p>
            <p>â‚±${item.price}</p>
          </div>
          <div class="flex gap-2 items-center">
            <button onclick="changeQty(${item.id},'${item.name}',${item.price},-1)">âˆ’</button>
            <span id="qty-${item.id}">0</span>
            <button class="bg-red-600 text-white px-2 rounded"
              onclick="changeQty(${item.id},'${item.name}',${item.price},1)">+</button>
          </div>
        </div>
      `;
      content.appendChild(div);
    });

    menuDiv.appendChild(section);
  });
}

function toggleCategory(btn) {
  btn.nextElementSibling.classList.toggle("hidden");
}

function openImage(src) {
  modalImg.src = src;
  imageModal.classList.remove("hidden");
}
function closeImage() {
  imageModal.classList.add("hidden");
}

function changeQty(id,name,price,delta){
  if(!order[id]) order[id]={name,price,qty:0};
  order[id].qty+=delta;
  if(order[id].qty<=0) delete order[id];
  document.getElementById(`qty-${id}`).innerText=order[id]?.qty||0;
  updateCart();
}

function updateCart(){
  cartQty=0; cartTotal=0;
  Object.values(order).forEach(i=>{
    cartQty+=i.qty; cartTotal+=i.qty*i.price;
  });
  cartQty?cartBar.classList.remove("hidden"):cartBar.classList.add("hidden");
  cartQtyEl.innerText=cartQty;
  cartTotalEl.innerText=cartTotal;
}

loadMenu();
</script>

</body>
</html>
